name: Code Analyzer

on:
  workflow_call:
    inputs:
      account_id:
        description: "CloudBot Account ID for S3 path (overrides secret)"
        required: false
        type: string
      project_name:
        description: "Project name (defaults to repository name)"
        required: false
        type: string
      upload_reports:
        description: "Upload code archive to S3 (requires AWS credentials)"
        required: false
        type: boolean
        default: false
      aws_region:
        description: "AWS region"
        required: false
        type: string
        default: "us-east-2"
      kms_key_alias:
        description: "KMS key alias for encryption"
        required: false
        type: string
        default: "alias/CloudBotPipelineKey"
      runner:
        description: "Runner label (default: self-hosted)"
        required: false
        type: string
    secrets:
      aws_role_arn:
        description: "AWS IAM role ARN for S3 uploads"
        required: true
      aws_account_id:
        description: "AWS Account ID (for bucket naming)"
        required: false
      accountid:
        description: "CloudBot Account ID for S3 upload paths"
        required: false

jobs:
  analyze:
    runs-on: ${{ inputs.runner || 'self-hosted' }}
    env:
      HOME: ${{ github.workspace }}/.home
    steps:
      - name: Configure Git (for self-hosted runners)
        run: |
          mkdir -p "$HOME"
          git config --global --add safe.directory '*' || true
          git config --global user.name "GitHub Actions" || true
          git config --global user.email "actions@github.com" || true
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git archive

      - name: Create code archive
        id: archive
        run: |
          echo "=== Creating Code Archive ==="

          # Generate timestamp (matches GitLab format: YYYYMMDD-HHMMSS)
          DATETIME=$(date +"%Y%m%d-%H%M%S")

          # Determine project name
          if [ -n "${{ inputs.project_name }}" ]; then
            PROJECT_NAME="${{ inputs.project_name }}"
          else
            PROJECT_NAME="${{ github.repository }}"
            # Remove owner/ prefix if present
            PROJECT_NAME="${PROJECT_NAME#*/}"
          fi

          # Create archive (matches GitLab: git archive --format=tar.gz)
          ARCHIVE_NAME="codeitem-${GITHUB_SHA}.tar.gz"
          git archive --format=tar.gz --output="${ARCHIVE_NAME}" HEAD

          echo "Archive created: ${ARCHIVE_NAME}"
          ls -lh "${ARCHIVE_NAME}"

          echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT

      - name: Configure AWS for S3 upload
        if: inputs.upload_reports
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: github-actions-code-analyzer

      - name: Upload code archive to S3
        if: inputs.upload_reports
        run: |
          echo "=== Uploading Code Archive to S3 ==="

          # Determine AWS Account ID (for bucket name)
          if [ -n "${{ secrets.aws_account_id }}" ]; then
            AWS_ACCOUNT_ID="${{ secrets.aws_account_id }}"
          else
            # Try to get from AWS identity
            AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          fi

          # Determine CloudBot ACCOUNTID (for S3 key path)
          ACCOUNTID="${{ inputs.account_id || secrets.accountid }}"
          if [ -z "$ACCOUNTID" ]; then
            echo "⚠️  Warning: ACCOUNTID not provided, cannot upload to S3"
            exit 0
          fi

          # S3 bucket uses AWS Account ID, key path uses CloudBot ACCOUNTID
          ARTIFACTS_BUCKET="cloudbot-codepipeline-artifacts-${{ inputs.aws_region }}-${AWS_ACCOUNT_ID}"
          S3_KEY="codeitems/${ACCOUNTID}/${{ steps.archive.outputs.project_name }}/codeitem-${GITHUB_SHA}.tar.gz"

          echo "Bucket: ${ARTIFACTS_BUCKET}"
          echo "Key: ${S3_KEY}"
          echo "Project: ${{ steps.archive.outputs.project_name }}"
          echo "AWS Account ID: ${AWS_ACCOUNT_ID}"
          echo "CloudBot ACCOUNTID: ${ACCOUNTID}"

          # Upload to S3 with KMS encryption
          if aws s3 cp "${{ steps.archive.outputs.archive_name }}" "s3://${ARTIFACTS_BUCKET}/${S3_KEY}" \
            --sse aws:kms \
            --sse-kms-key-id ${{ inputs.kms_key_alias }} \
            --region ${{ inputs.aws_region }} 2>&1; then
            echo "✅ Code archive uploaded successfully"
            echo "S3 URL: s3://${ARTIFACTS_BUCKET}/${S3_KEY}"
          else
            echo "⚠️  Warning: Failed to upload code archive to S3"
            echo "This may be expected if AWS credentials are not configured"
            exit 0  # Don't fail the job
          fi

      - name: Upload archive as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-archive
          path: ${{ steps.archive.outputs.archive_name }}
          retention-days: 7
